{% extends "base.html" %}

{% block lab %}–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞—è —Ä–∞–±–æ—Ç–∞ 9{% endblock %}

{% block main %}
    <h1 style="text-align: center; color: #2c3e50; margin-bottom: 30px;">–ù–æ–≤–æ–≥–æ–¥–Ω–∏–µ –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏—è üéÑ</h1>
    
    <div style="text-align: center; margin-bottom: 20px;">
        <div style="display: inline-block; padding: 10px 20px; background: #f0f0f0; border-radius: 10px; margin-right: 20px;">
            –í—ã –æ—Ç–∫—Ä—ã–ª–∏: <strong id="user-count">{{ opened_count }}</strong> –∏–∑ 3 –∫–æ—Ä–æ–±–æ–∫<br>
            –û—Å—Ç–∞–ª–æ—Å—å –ø–æ–¥–∞—Ä–∫–æ–≤: <strong id="global-count">{{ remaining }}</strong> –∏–∑ 10
        </div>
        
        {% if current_user.is_authenticated %}
        <button onclick="santaRefill()" 
                style="padding: 8px 15px; 
                       background: #c62828; 
                       color: white; 
                       border: none; 
                       border-radius: 5px; 
                       font-size: 14px; 
                       cursor: pointer;">
            üéÖ –î–µ–¥ –ú–æ—Ä–æ–∑
        </button>
        {% endif %}
        
        <div id="limit-message" style="margin-top: 10px; 
             {% if opened_count >= 3 %}color: #e74c3c; font-weight: bold;
             {% else %}color: #666; font-style: italic;{% endif %}">
            {% if opened_count >= 3 %}
                ‚ùå –í—ã –¥–æ—Å—Ç–∏–≥–ª–∏ –ª–∏–º–∏—Ç–∞ –≤ 3 –∫–æ—Ä–æ–±–∫–∏! –°–±—Ä–æ—Å—å—Ç–µ —Å—á–µ—Ç—á–∏–∫, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –µ—â–µ.
            {% else %}
                –í—ã –º–æ–∂–µ—Ç–µ –æ—Ç–∫—Ä—ã—Ç—å –µ—â–µ {{ 3 - opened_count }} –∫–æ—Ä–æ–±–∫–∏(—É)
            {% endif %}
        </div>
        
        {% if not current_user.is_authenticated %}
        <div style="margin-top: 10px; color: #ff9800; font-weight: bold;">
            ‚≠ê –ü–æ–¥–∞—Ä–∫–∏ —Å –∑–æ–ª–æ—Ç–æ–π —Ä–∞–º–∫–æ–π –¥–æ—Å—Ç—É–ø–Ω—ã —Ç–æ–ª—å–∫–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º!
        </div>
        {% endif %}
    </div>
    
    <p style="text-align: center; color: #666; font-size: 18px; margin-bottom: 30px;">
        –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –ª—é–±—É—é –∫–æ—Ä–æ–±–∫—É —Å –ø–æ–¥–∞—Ä–∫–æ–º, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ –∏ –ø–æ–¥–∞—Ä–æ–∫!
    </p>

    <div id="congrats-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                   background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%); 
                   padding: 50px; border-radius: 20px; 
                   width: 1200px; max-width: 95%; max-height: 90vh;
                   box-shadow: 0 20px 60px rgba(0,0,0,0.4);
                   text-align: center;
                   overflow-y: auto;">
            <h2 id="congrats-text" style="color: #0c00b8; margin-top: 0; font-size: 38px; font-weight: bold; 
                      text-shadow: 2px 2px 4px rgba(0,0,0,0.1); margin-bottom: 30px;"></h2>
            
            <img id="gift-image" src="" style="width: 600px; height: 600px; max-width: 80%; max-height: 50vh;
                     object-fit: cover; 
                     border-radius: 15px; border: 6px solid white; 
                     box-shadow: 0 15px 40px rgba(0,0,0,0.3);
                     margin: 20px auto; display: block;">
            
            <button onclick="closeModal()" 
                    style="padding: 15px 60px; 
                           background: #a1887f;
                           color: white; border: none; border-radius: 10px; 
                           font-size: 22px; cursor: pointer; 
                           margin-top: 30px; font-weight: bold;
                           box-shadow: 0 8px 25px rgba(161, 136, 127, 0.4);
                           display: block;
                           margin-left: auto;
                           margin-right: auto;">
                –ó–∞–∫—Ä—ã—Ç—å
            </button>
        </div>
    </div>
    
    <div style="position: relative; width: 100%; height: 80vh; margin-top: 20px;">
        {% for img in images %}
        <div id="gift-box-{{ img.id }}" 
             {% if img.available and not img.opened and opened_count < 3 %}onclick="openGift({{ img.id }})"{% endif %}
             style="position: absolute; 
                    left: {{img.left}}%; 
                    top: {{img.top}}%; 
                    width: 230px; 
                    height: 230px; 
                    cursor: {% if not img.available or img.opened or opened_count >= 3 %}default{% else %}pointer{% endif %};
                    opacity: {{ '0.7' if img.opened else '1' }};
                    transition: opacity 0.3s;
                    {% if img.premium and not current_user.is_authenticated %}
                    filter: grayscale(70%);
                    {% endif %}">
            <img src="{{ url_for('static', filename=img.path) }}" 
                 alt="–ü–æ–¥–∞—Ä–æ–∫ {{ loop.index }}"
                 style="width: 100%; 
                        height: 100%; 
                        object-fit: cover;
                        border: 4px solid {{ '#a1887f' if not img.opened else '#cccccc' }};
                        {% if img.premium %}border-color: #ff9800; border-width: 5px;{% endif %}
                        border-radius: 15px;        
                        box-shadow: 0 4px 10px rgba(0,0,0,0.2);">  
            
            {% if img.premium %}
            <div style="position: absolute; top: 5px; right: 5px; background: #ff9800; color: white; 
                       padding: 3px 8px; border-radius: 10px; font-size: 12px; font-weight: bold;">
                ‚≠ê
            </div>
            {% endif %}
            
            {% if img.premium and not current_user.is_authenticated and not img.opened %}
            <div style="position: absolute; 
                        top: 0; 
                        left: 0; 
                        width: 100%; 
                        height: 100%; 
                        background: rgba(0,0,0,0.7); 
                        color: #ff9800; 
                        font-size: 16px; 
                        display: flex; 
                        align-items: center; 
                        justify-content: center; 
                        border-radius: 15px;
                        font-weight: bold;
                        text-align: center;
                        padding: 10px;">
                üîí –¢–æ–ª—å–∫–æ –¥–ª—è<br>–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö
            </div>
            {% endif %}
            
            {% if img.opened %}
            <div style="position: absolute; 
                        top: 0; 
                        left: 0; 
                        width: 100%; 
                        height: 100%; 
                        background: rgba(0,0,0,0.6); 
                        color: rgb(0, 255, 13); 
                        font-size: 20px; 
                        display: flex; 
                        align-items: center; 
                        justify-content: center; 
                        border-radius: 15px;
                        font-weight: bold;
                        text-align: center;
                        padding: 10px;">
                –û, –Ω–µ—Ç! –ì—Ä–∏–Ω—á –ø–æ—Ö–∏—Ç–∏–ª –ø–æ–¥–∞—Ä–æ–∫!
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
    
    <div style="height: 200px;"></div>

    <script>
        let openedCount = {{ opened_count }};
        
        function openGift(id) {
            if (openedCount >= 3) return alert('‚ùå –í—ã —É–∂–µ –æ—Ç–∫—Ä—ã–ª–∏ 3 –∫–æ—Ä–æ–±–∫–∏!');
            const giftBox = document.getElementById(`gift-box-${id}`);
            if (giftBox.style.opacity === '0.7') return alert('–≠—Ç–æ—Ç –ø–æ–¥–∞—Ä–æ–∫ —É–∂–µ –æ—Ç–∫—Ä—ã—Ç!');
            
            fetch('/lab9/open_gift', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ gift_id: parseInt(id) })
            })
            .then(r => r.json())
            .then(r => {
                if (r.success) {
                    openedCount = r.opened_count;
                    giftBox.style.opacity = '0.7';
                    giftBox.querySelector('img').style.borderColor = '#cccccc';
                    giftBox.onclick = null;
                    giftBox.style.cursor = 'default';
                    
                    const div = document.createElement('div');
                    div.innerHTML = '–û, –Ω–µ—Ç! –ì—Ä–∏–Ω—á –ø–æ—Ö–∏—Ç–∏–ª –ø–æ–¥–∞—Ä–æ–∫!';
                    div.style.cssText = `position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);color:#00ff0d;font-size:20px;display:flex;align-items:center;justify-content:center;border-radius:15px;font-weight:bold;text-align:center;padding:10px;`;
                    giftBox.appendChild(div);
                    
                    document.getElementById('congrats-text').textContent = r.congrats;
                    document.getElementById('gift-image').src = '/static/' + r.gift_image;
                    document.getElementById('congrats-modal').style.display = 'block';
                    
                    document.getElementById('user-count').textContent = openedCount;
                    document.getElementById('global-count').textContent = r.remaining;
                    updateMessage();
                    
                    if (openedCount >= 3) blockAllGifts();
                } else {
                    if (r.error === '–í—ã —É–∂–µ –æ—Ç–∫—Ä—ã–ª–∏ 3 –∫–æ—Ä–æ–±–∫–∏') {
                        alert('‚ùå –í—ã —É–∂–µ –æ—Ç–∫—Ä—ã–ª–∏ 3 –∫–æ—Ä–æ–±–∫–∏!');
                        blockAllGifts();
                        updateMessage();
                    } else if (r.error === '–ü–æ–¥–∞—Ä–æ–∫ —É–∂–µ –æ—Ç–∫—Ä—ã—Ç') {
                        alert('–≠—Ç–æ—Ç –ø–æ–¥–∞—Ä–æ–∫ —É–∂–µ –æ—Ç–∫—Ä—ã—Ç!');
                    } else if (r.error.includes('–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–º')) {
                        alert('‚ùå ' + r.error + '\n\n–í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É!');
                    }
                }
            });
        }
        
        function blockAllGifts() {
            document.querySelectorAll('[id^="gift-box-"]').forEach(box => {
                if (box.style.opacity !== '0.7') {
                    box.style.cursor = 'default';
                    box.onclick = null;
                }
            });
        }
        
        function updateMessage() {
            const msg = document.getElementById('limit-message');
            if (openedCount >= 3) {
                msg.innerHTML = '‚ùå –í—ã –¥–æ—Å—Ç–∏–≥–ª–∏ –ª–∏–º–∏—Ç–∞ –≤ 3 –∫–æ—Ä–æ–±–∫–∏!';
                msg.style.color = '#e74c3c';
                msg.style.fontWeight = 'bold';
                msg.style.fontStyle = 'normal';
            } else {
                msg.innerHTML = `–í—ã –º–æ–∂–µ—Ç–µ –æ—Ç–∫—Ä—ã—Ç—å –µ—â–µ ${3 - openedCount} –∫–æ—Ä–æ–±–∫–∏(—É)`;
                msg.style.color = '#666';
                msg.style.fontStyle = 'italic';
                msg.style.fontWeight = 'normal';
            }
        }
        
        function closeModal() {
            document.getElementById('congrats-modal').style.display = 'none';
        }
        
        function santaRefill() {
            if (!{{ 'true' if current_user.is_authenticated else 'false' }}) {
                return alert('‚ùå –¢–æ–ª—å–∫–æ –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö!');
            }
            
            if (confirm('üéÖ –î–µ–¥ –ú–æ—Ä–æ–∑ –Ω–∞–ø–æ–ª–Ω–∏—Ç –≤—Å–µ –∫–æ—Ä–æ–±–∫–∏?')) {
                fetch('/lab9/santa_refill', {method: 'POST', headers: {'Content-Type': 'application/json'}})
                .then(r => r.json())
                .then(r => {
                    if (r.success) {
                        alert(r.message);
                        location.reload();
                    }
                });
            }
        }
    </script>
{% endblock %}