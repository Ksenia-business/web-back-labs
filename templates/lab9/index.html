{% extends "base.html" %}

{% block lab %}–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞—è —Ä–∞–±–æ—Ç–∞ 9{% endblock %}

{% block main %}
    <h1 style="text-align: center; color: #2c3e50; margin-bottom: 30px;">–ù–æ–≤–æ–≥–æ–¥–Ω–∏–µ –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏—è üéÑ</h1>
    
    <div style="text-align: center; margin-bottom: 20px;">
        <div style="display: inline-block; padding: 10px 20px; background: #f0f0f0; border-radius: 10px; margin-right: 20px;">
            –í—ã –æ—Ç–∫—Ä—ã–ª–∏: <strong id="user-count">{{ opened_count }}</strong> –∏–∑ 3 –∫–æ—Ä–æ–±–æ–∫<br>
            –û—Å—Ç–∞–ª–æ—Å—å –ø–æ–¥–∞—Ä–∫–æ–≤: <strong id="global-count">{{ remaining }}</strong> –∏–∑ 10
        </div>
        <button onclick="resetCounter()" 
                style="padding: 8px 15px; 
                       background: #4c77af; 
                       color: white; 
                       border: none; 
                       border-radius: 5px; 
                       font-size: 14px; 
                       cursor: pointer;">
            –°–±—Ä–æ—Å–∏—Ç—å –º–æ–∏ –∫–æ—Ä–æ–±–∫–∏
        </button>
        
        <div id="limit-message" style="margin-top: 10px; 
             {% if opened_count >= 3 %}color: #e74c3c; font-weight: bold;
             {% else %}color: #666; font-style: italic;{% endif %}">
            {% if opened_count >= 3 %}
                ‚ùå –í—ã –¥–æ—Å—Ç–∏–≥–ª–∏ –ª–∏–º–∏—Ç–∞ –≤ 3 –∫–æ—Ä–æ–±–∫–∏! –°–±—Ä–æ—Å—å—Ç–µ —Å—á–µ—Ç—á–∏–∫, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –µ—â–µ.
            {% else %}
                –í—ã –º–æ–∂–µ—Ç–µ –æ—Ç–∫—Ä—ã—Ç—å –µ—â–µ {{ 3 - opened_count }} –∫–æ—Ä–æ–±–∫–∏(—É)
            {% endif %}
        </div>
    </div>
    
    <p style="text-align: center; color: #666; font-size: 18px; margin-bottom: 30px;">
        –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –ª—é–±—É—é –∫–æ—Ä–æ–±–∫—É —Å –ø–æ–¥–∞—Ä–∫–æ–º, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ –∏ –ø–æ–¥–∞—Ä–æ–∫!
    </p>

    <div id="congrats-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                   background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%); 
                   padding: 50px; border-radius: 20px; 
                   width: 1200px; max-width: 95%; max-height: 90vh;
                   box-shadow: 0 20px 60px rgba(0,0,0,0.4);
                   text-align: center;
                   overflow-y: auto;">
            <h2 id="congrats-text" style="color: #0c00b8; margin-top: 0; font-size: 38px; font-weight: bold; 
                      text-shadow: 2px 2px 4px rgba(0,0,0,0.1); margin-bottom: 30px;"></h2>
            
            <img id="gift-image" src="" style="width: 600px; height: 600px; max-width: 80%; max-height: 50vh;
                     object-fit: cover; 
                     border-radius: 15px; border: 6px solid white; 
                     box-shadow: 0 15px 40px rgba(0,0,0,0.3);
                     margin: 20px auto; display: block;">
            
            <button onclick="closeModal()" 
                    style="padding: 15px 60px; 
                           background: #a1887f;
                           color: white; border: none; border-radius: 10px; 
                           font-size: 22px; cursor: pointer; 
                           margin-top: 30px; font-weight: bold;
                           box-shadow: 0 8px 25px rgba(161, 136, 127, 0.4);
                           display: block;
                           margin-left: auto;
                           margin-right: auto;">
                –ó–∞–∫—Ä—ã—Ç—å
            </button>
        </div>
    </div>
    
    <div style="position: relative; width: 100%; height: 80vh; margin-top: 20px;">
        {% for img in images %}
        <div id="gift-box-{{ img.id }}" 
             {% if not img.opened and opened_count < 3 %}onclick="openGift({{ img.id }})"{% endif %}
             style="position: absolute; 
                    left: {{img.left}}%; 
                    top: {{img.top}}%; 
                    width: 230px; 
                    height: 230px; 
                    cursor: {% if img.opened or opened_count >= 3 %}default{% else %}pointer{% endif %};
                    opacity: {{ '0.7' if img.opened else '1' }};
                    transition: opacity 0.3s;">
            <img src="{{ url_for('static', filename=img.path) }}" 
                 alt="–ü–æ–¥–∞—Ä–æ–∫ {{ loop.index }}"
                 style="width: 100%; 
                        height: 100%; 
                        object-fit: cover;
                        border: 4px solid {{ '#a1887f' if not img.opened else '#cccccc' }};  
                        border-radius: 15px;        
                        box-shadow: 0 4px 10px rgba(0,0,0,0.2);">  
            {% if img.opened %}
            <div style="position: absolute; 
                        top: 0; 
                        left: 0; 
                        width: 100%; 
                        height: 100%; 
                        background: rgba(0,0,0,0.6); 
                        color: rgb(0, 255, 13); 
                        font-size: 20px; 
                        display: flex; 
                        align-items: center; 
                        justify-content: center; 
                        border-radius: 15px;
                        font-weight: bold;
                        text-align: center;
                        padding: 10px;">
                –û, –Ω–µ—Ç! –ì—Ä–∏–Ω—á –ø–æ—Ö–∏—Ç–∏–ª –ø–æ–¥–∞—Ä–æ–∫!
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
    
    <div style="height: 200px;"></div>

    <script>
        let openedCount = {{ opened_count }};
        
        function openGift(id) {
            if (openedCount >= 3) {
                alert('‚ùå –í—ã —É–∂–µ –æ—Ç–∫—Ä—ã–ª–∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ—Ä–æ–±–æ–∫ (3)!');
                return;
            }
            
            const giftBox = document.getElementById(`gift-box-${id}`);
            if (giftBox.style.opacity === '0.7') {
                alert('–≠—Ç–æ—Ç –ø–æ–¥–∞—Ä–æ–∫ —É–∂–µ –æ—Ç–∫—Ä—ã—Ç! –í—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥—É—é –∫–æ—Ä–æ–±–∫—É.');
                return;
            }
            
            fetch('/lab9/open_gift', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ gift_id: parseInt(id) })
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    openedCount = result.opened_count;
                    
                    updateGiftBox(id);
                    updateCounters(result.opened_count, result.remaining);
                    showCongrats(result.congrats, result.gift_image);
                    
                } else {
                    handleError(result.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –ø–æ–¥–∞—Ä–∫–∞');
            });
        }
        
        function updateGiftBox(id) {
            const giftBox = document.getElementById(`gift-box-${id}`);
            giftBox.style.opacity = '0.7';
            giftBox.querySelector('img').style.borderColor = '#cccccc';
            giftBox.onclick = null;
            giftBox.style.cursor = 'default';
            
            const messageDiv = document.createElement('div');
            messageDiv.innerHTML = '–û, –Ω–µ—Ç! –ì—Ä–∏–Ω—á –ø–æ—Ö–∏—Ç–∏–ª –ø–æ–¥–∞—Ä–æ–∫!';
            messageDiv.style.cssText = `
                position: absolute; 
                top: 0; left: 0; 
                width: 100%; height: 100%; 
                background: rgba(0,0,0,0.6); 
                color: rgb(0, 255, 13); 
                font-size: 20px; 
                display: flex; 
                align-items: center; 
                justify-content: center; 
                border-radius: 15px;
                font-weight: bold;
                text-align: center;
                padding: 10px;
            `;
            giftBox.appendChild(messageDiv);
        }
        
        function updateCounters(count, remaining) {
            document.getElementById('user-count').textContent = count;
            document.getElementById('global-count').textContent = remaining;
            
            const msg = document.getElementById('limit-message');
            if (count >= 3) {
                msg.innerHTML = '‚ùå –í—ã –¥–æ—Å—Ç–∏–≥–ª–∏ –ª–∏–º–∏—Ç–∞ –≤ 3 –∫–æ—Ä–æ–±–∫–∏! –°–±—Ä–æ—Å—å—Ç–µ —Å—á–µ—Ç—á–∏–∫, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –µ—â–µ.';
                msg.style.color = '#e74c3c';
                msg.style.fontWeight = 'bold';
                msg.style.fontStyle = 'normal';
                
                document.querySelectorAll('[id^="gift-box-"]').forEach(box => {
                    if (box.style.opacity !== '0.7') {
                        box.style.cursor = 'default';
                        box.onclick = null;
                    }
                });
            } else {
                msg.innerHTML = `–í—ã –º–æ–∂–µ—Ç–µ –æ—Ç–∫—Ä—ã—Ç—å –µ—â–µ ${3 - count} –∫–æ—Ä–æ–±–∫–∏(—É)`;
                msg.style.color = '#666';
                msg.style.fontWeight = 'normal';
                msg.style.fontStyle = 'italic';
            }
        }
        
        function showCongrats(text, image) {
            document.getElementById('congrats-text').textContent = text;
            document.getElementById('gift-image').src = '/static/' + image;
            document.getElementById('congrats-modal').style.display = 'block';
        }
        
        function closeModal() {
            document.getElementById('congrats-modal').style.display = 'none';
        }
        
        function handleError(error) {
            if (error === '–í—ã —É–∂–µ –æ—Ç–∫—Ä—ã–ª–∏ 3 –∫–æ—Ä–æ–±–∫–∏') {
                alert('‚ùå –í—ã —É–∂–µ –æ—Ç–∫—Ä—ã–ª–∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ—Ä–æ–±–æ–∫ (3)!');
                updateCounters(3, document.getElementById('global-count').textContent);
            } else if (error === '–ü–æ–¥–∞—Ä–æ–∫ —É–∂–µ –æ—Ç–∫—Ä—ã—Ç') {
                alert('–≠—Ç–æ—Ç –ø–æ–¥–∞—Ä–æ–∫ —É–∂–µ –æ—Ç–∫—Ä—ã—Ç! –í—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥—É—é –∫–æ—Ä–æ–±–∫—É.');
            }
        }
        
        function resetCounter() {
            if (confirm('–°–±—Ä–æ—Å–∏—Ç—å —Å—á–µ—Ç—á–∏–∫ –≤–∞—à–∏—Ö –æ—Ç–∫—Ä—ã—Ç—ã—Ö –∫–æ—Ä–æ–±–æ–∫? –í—Å–µ –æ—Ç–∫—Ä—ã—Ç—ã–µ –≤–∞–º–∏ –∫–æ—Ä–æ–±–∫–∏ –±—É–¥—É—Ç —Å–±—Ä–æ—à–µ–Ω—ã.')) {
                fetch('/lab9/reset_count', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        alert(result.message);
                        
                        openedCount = 0;
                        
                        document.querySelectorAll('[id^="gift-box-"]').forEach(box => {
                            box.style.opacity = '1';
                            box.style.cursor = 'pointer';
                            box.querySelector('img').style.borderColor = '#a1887f';
                            
                            box.querySelectorAll('div').forEach(div => div.remove());
                            
                            box.onclick = () => openGift(box.id.split('-')[2]);
                        });
                        
                        updateCounters(0, 10);
                        
                    } else {
                        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±—Ä–æ—Å–µ —Å—á–µ—Ç—á–∏–∫–∞');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±—Ä–æ—Å–µ —Å—á–µ—Ç—á–∏–∫–∞');
                });
            }
        }
    </script>
{% endblock %}