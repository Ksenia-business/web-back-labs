{% extends "base.html" %}

{% block lab %}–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞—è —Ä–∞–±–æ—Ç–∞ 9{% endblock %}

{% block main %}
    <h1 style="text-align: center; color: #2c3e50; margin-bottom: 30px;">–ù–æ–≤–æ–≥–æ–¥–Ω–∏–µ –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏—è üéÑ</h1>
    
    {% if session.get('error') %}
    <div style="text-align: center; margin-bottom: 20px; padding: 10px; background: #ffebee; color: #c62828; border-radius: 5px;">
        {{ session.pop('error', '') }}
    </div>
    {% endif %}
    
    {% if session.get('message') %}
    <div style="text-align: center; margin-bottom: 20px; padding: 10px; background: #e8f5e9; color: #2e7d32; border-radius: 5px;">
        {{ session.pop('message', '') }}
    </div>
    {% endif %}
    
    <div style="text-align: center; margin-bottom: 20px;">
        <div style="display: inline-block; padding: 10px 20px; background: #f0f0f0; border-radius: 10px; margin-right: 20px;">
            –í—ã –æ—Ç–∫—Ä—ã–ª–∏: <strong>{{ opened_count }}</strong> –∏–∑ 3 –∫–æ—Ä–æ–±–æ–∫<br>
            –û—Å—Ç–∞–ª–æ—Å—å –ø–æ–¥–∞—Ä–∫–æ–≤: <strong>{{ remaining }}</strong> –∏–∑ 10
        </div>
        
        {% if current_user.is_authenticated %}
        <form action="{{ url_for('lab9.santa_refill') }}" method="POST" style="display: inline;">
            <button type="submit" 
                    style="padding: 8px 15px; 
                           background: #c62828; 
                           color: white; 
                           border: none; 
                           border-radius: 5px; 
                           font-size: 14px; 
                           cursor: pointer;">
                üéÖ –î–µ–¥ –ú–æ—Ä–æ–∑
            </button>
        </form>
        {% endif %}
        
        <div style="margin-top: 10px; 
             {% if opened_count >= 3 %}color: #e74c3c; font-weight: bold;
             {% else %}color: #666; font-style: italic;{% endif %}">
            {% if opened_count >= 3 %}
                ‚ùå –í—ã –¥–æ—Å—Ç–∏–≥–ª–∏ –ª–∏–º–∏—Ç–∞ –≤ 3 –∫–æ—Ä–æ–±–∫–∏!
            {% else %}
                –í—ã –º–æ–∂–µ—Ç–µ –æ—Ç–∫—Ä—ã—Ç—å –µ—â–µ {{ 3 - opened_count }} –∫–æ—Ä–æ–±–∫–∏(—É)
            {% endif %}
        </div>
        
        {% if not current_user.is_authenticated %}
        <div style="margin-top: 10px; color: #ff9800; font-weight: bold;">
            ‚≠ê –ü–æ–¥–∞—Ä–∫–∏ —Å –∑–æ–ª–æ—Ç–æ–π —Ä–∞–º–∫–æ–π –¥–æ—Å—Ç—É–ø–Ω—ã —Ç–æ–ª—å–∫–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º!
        </div>
        {% endif %}
    </div>
    
    <p style="text-align: center; color: #666; font-size: 18px; margin-bottom: 30px;">
        –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –ª—é–±—É—é –∫–æ—Ä–æ–±–∫—É —Å –ø–æ–¥–∞—Ä–∫–æ–º, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ –∏ –ø–æ–¥–∞—Ä–æ–∫!
    </p>

    {% if show_congrats and last_gift_data %}
    <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                   background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%); 
                   padding: 50px; border-radius: 20px; 
                   width: 1200px; max-width: 95%; max-height: 90vh;
                   box-shadow: 0 20px 60px rgba(0,0,0,0.4);
                   text-align: center;
                   overflow-y: auto;">
            <h2 style="color: #0c00b8; margin-top: 0; font-size: 38px; font-weight: bold; 
                      text-shadow: 2px 2px 4px rgba(0,0,0,0.1); margin-bottom: 30px;">
                {{ last_gift_data.congrats }}
            </h2>
            
            <img src="{{ url_for('static', filename=last_gift_data.gift_image) }}" 
                 style="width: 600px; height: 600px; max-width: 80%; max-height: 50vh;
                     object-fit: cover; 
                     border-radius: 15px; border: 6px solid white; 
                     box-shadow: 0 15px 40px rgba(0,0,0,0.3);
                     margin: 20px auto; display: block;">
            
            <form action="{{ url_for('lab9.close_congrats') }}" method="POST">
                <button type="submit" 
                        style="padding: 15px 60px; 
                               background: #a1887f;
                               color: white; border: none; border-radius: 10px; 
                               font-size: 22px; cursor: pointer; 
                               margin-top: 30px; font-weight: bold;
                               box-shadow: 0 8px 25px rgba(161, 136, 127, 0.4);
                               display: block;
                               margin-left: auto;
                               margin-right: auto;">
                    –ó–∞–∫—Ä—ã—Ç—å
                </button>
            </form>
        </div>
    </div>
    {% endif %}
    
    <div style="position: relative; width: 100%; height: 80vh; margin-top: 20px;">
        {% for img in images %}
        <div style="position: absolute; 
                    left: {{img.left}}%; 
                    top: {{img.top}}%; 
                    width: 230px; 
                    height: 230px; 
                    opacity: {{ '0.7' if img.opened else '1' }};
                    transition: opacity 0.3s;
                    {% if img.premium and not current_user.is_authenticated %}
                    filter: grayscale(70%);
                    {% endif %}">
            
            {% if img.available and not img.opened and opened_count < 3 %}
            <form action="{{ url_for('lab9.open_gift', gift_id=img.id) }}" method="POST" style="margin: 0; padding: 0;">
                <button type="submit" 
                        style="width: 100%; height: 100%; padding: 0; border: none; background: none; cursor: pointer;">
                    <img src="{{ url_for('static', filename=img.path) }}" 
                         alt="–ü–æ–¥–∞—Ä–æ–∫ {{ loop.index }}"
                         style="width: 100%; 
                                height: 100%; 
                                object-fit: cover;
                                border: 4px solid {{ '#a1887f' if not img.opened else '#cccccc' }};
                                {% if img.premium %}border-color: #ff9800; border-width: 5px;{% endif %}
                                border-radius: 15px;        
                                box-shadow: 0 4px 10px rgba(0,0,0,0.2);">
                </button>
            </form>
            {% else %}
            <img src="{{ url_for('static', filename=img.path) }}" 
                 alt="–ü–æ–¥–∞—Ä–æ–∫ {{ loop.index }}"
                 style="width: 100%; 
                        height: 100%; 
                        object-fit: cover;
                        border: 4px solid {{ '#a1887f' if not img.opened else '#cccccc' }};
                        {% if img.premium %}border-color: #ff9800; border-width: 5px;{% endif %}
                        border-radius: 15px;        
                        box-shadow: 0 4px 10px rgba(0,0,0,0.2);">
            {% endif %}
            
            {% if img.premium %}
            <div style="position: absolute; top: 5px; right: 5px; background: #ff9800; color: white; 
                       padding: 3px 8px; border-radius: 10px; font-size: 12px; font-weight: bold;">
                ‚≠ê
            </div>
            {% endif %}
            
            {% if img.premium and not current_user.is_authenticated and not img.opened %}
            <div style="position: absolute; 
                        top: 0; 
                        left: 0; 
                        width: 100%; 
                        height: 100%; 
                        background: rgba(0,0,0,0.7); 
                        color: #ff9800; 
                        font-size: 16px; 
                        display: flex; 
                        align-items: center; 
                        justify-content: center; 
                        border-radius: 15px;
                        font-weight: bold;
                        text-align: center;
                        padding: 10px;">
                üîí –¢–æ–ª—å–∫–æ –¥–ª—è<br>–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö
            </div>
            {% endif %}
            
            {% if img.opened %}
            <div style="position: absolute; 
                        top: 0; 
                        left: 0; 
                        width: 100%; 
                        height: 100%; 
                        background: rgba(0,0,0,0.6); 
                        color: rgb(0, 255, 13); 
                        font-size: 20px; 
                        display: flex; 
                        align-items: center; 
                        justify-content: center; 
                        border-radius: 15px;
                        font-weight: bold;
                        text-align: center;
                        padding: 10px;">
                –û, –Ω–µ—Ç! –ì—Ä–∏–Ω—á –ø–æ—Ö–∏—Ç–∏–ª –ø–æ–¥–∞—Ä–æ–∫!
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
    
    <div style="height: 200px;"></div>
{% endblock %}